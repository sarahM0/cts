{"version":3,"sources":["../../../src/common/tools/crawl.ts"],"names":["fs","path","validQueryPart","assert","unreachable","fg","require","specFileSuffix","crawl","suite","suiteDir","existsSync","console","error","process","exit","glob","filesToEnumerate","onlyFiles","sort","entries","file","f","substring","length","endsWith","filepathWithoutExtension","filename","mod","env","STANDALONE_DEV_SERVER","cache","resolve","description","undefined","g","validate","split","p","test","push","trim","basename","readme","readFileSync","makeListing","dirname"],"mappings":"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","sourcesContent":["// Node can look at the filesystem, but JS in the browser can't.\n// This crawls the file tree under src/suites/${suite} to generate a (non-hierarchical) static\n// listing file that can then be used in the browser to load the modules containing the tests.\n\nimport * as fs from 'fs';\nimport * as path from 'path';\n\nimport { SpecFile } from '../framework/file_loader.js';\nimport { validQueryPart } from '../framework/query/validQueryPart.js';\nimport { TestSuiteListingEntry, TestSuiteListing } from '../framework/test_suite_listing.js';\nimport { assert, unreachable } from '../framework/util/util.js';\n\nconst fg = require('fast-glob');\n\nconst specFileSuffix = '.spec.ts';\n\nexport async function crawl(suite: string): Promise<TestSuiteListingEntry[]> {\n  const suiteDir = 'src/' + suite;\n  if (!fs.existsSync(suiteDir)) {\n    console.error(`Could not find ${suiteDir}`);\n    process.exit(1);\n  }\n\n  const glob = `${suiteDir}/**/{README.txt,*${specFileSuffix}}`;\n  const filesToEnumerate: string[] = await fg(glob, { onlyFiles: true });\n  filesToEnumerate.sort();\n\n  const entries: TestSuiteListingEntry[] = [];\n  for (const file of filesToEnumerate) {\n    const f = file.substring((suiteDir + '/').length); // Suite-relative file path\n    if (f.endsWith(specFileSuffix)) {\n      const filepathWithoutExtension = f.substring(0, f.length - specFileSuffix.length);\n      const filename = `../../../${suiteDir}/${filepathWithoutExtension}.spec.js`;\n\n      let mod: SpecFile;\n      if (process.env.STANDALONE_DEV_SERVER) {\n        mod = require(filename) as SpecFile;\n        // Delete the cache so that changes to the file are picked up.\n        delete require.cache[require.resolve(filename)];\n      } else {\n        mod = (await import(filename)) as SpecFile;\n      }\n      assert(mod.description !== undefined, 'Test spec file missing description: ' + filename);\n      assert(mod.g !== undefined, 'Test spec file missing TestGroup definition: ' + filename);\n\n      mod.g.validate();\n\n      const path = filepathWithoutExtension.split('/');\n      for (const p of path) {\n        assert(validQueryPart.test(p), `Invalid directory name ${p}; must match ${validQueryPart}`);\n      }\n      entries.push({ file: path, description: mod.description.trim() });\n    } else if (path.basename(file) === 'README.txt') {\n      const filepathWithoutExtension = f.substring(0, f.length - '/README.txt'.length);\n      const readme = fs.readFileSync(file, 'utf8').trim();\n\n      const path = filepathWithoutExtension ? filepathWithoutExtension.split('/') : [];\n      entries.push({ file: path, readme });\n    } else {\n      unreachable(`glob ${glob} matched an unrecognized filename ${file}`);\n    }\n  }\n\n  return entries;\n}\n\nexport function makeListing(filename: string): Promise<TestSuiteListing> {\n  const suite = path.basename(path.dirname(filename));\n  return crawl(suite);\n}\n"],"file":"crawl.js"}