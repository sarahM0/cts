{"version":3,"sources":["../../../../../src/webgpu/api/operation/render_pipeline/culling_tests.spec.ts"],"names":["description","poptions","params","makeTestGroup","GPUTest","faceIsCulled","face","frontFace","cullMode","faceColor","isCulled","Uint8Array","g","test","combine","fn","t","size","format","texture","device","createTexture","width","height","depth","usage","GPUTextureUsage","OUTPUT_ATTACHMENT","COPY_SRC","depthTexture","depthStencilFormat","encoder","createCommandEncoder","pass","beginRenderPass","colorAttachments","attachment","createView","loadValue","r","b","a","depthStencilAttachment","depthLoadValue","depthStoreOp","stencilLoadValue","stencilStoreOp","undefined","setPipeline","createRenderPipeline","vertexStage","module","createShaderModule","code","entryPoint","fragmentStage","primitiveTopology","rasterizationState","colorStates","depthStencilState","draw","endPass","defaultQueue","submit","finish","kCCWTriangleTopLeftColor","expectSinglePixelIn2DTexture","x","y","exp","kCWTriangleBottomRightColor"],"mappings":"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","sourcesContent":["export const description = `Test culling and rasterizaion state.\n\nTest coverage:\nTest all culling combinations of GPUFrontFace and GPUCullMode show the correct output.\n\nUse 2 triangles with different winding orders:\n\n- Test that the counter-clock wise triangle has correct output for:\n  - All FrontFaces (ccw, cw)\n  - All CullModes (none, front, back)\n  - All depth stencil attachment types (none, depth24plus, depth32float, depth24plus-stencil8)\n  - Some primitive topologies (triangle-list, TODO: triangle-strip)\n\n- Test that the clock wise triangle has correct output for:\n  - All FrontFaces (ccw, cw)\n  - All CullModes (none, front, back)\n  - All depth stencil attachment types (none, depth24plus, depth32float, depth24plus-stencil8)\n  - Some primitive topologies (triangle-list, TODO: triangle-strip)\n`;\n\nimport { poptions, params } from '../../../../common/framework/params_builder.js';\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { GPUTest } from '../../../gpu_test.js';\n\nfunction faceIsCulled(face: 'cw' | 'ccw', frontFace: GPUFrontFace, cullMode: GPUCullMode): boolean {\n  return cullMode !== 'none' && (frontFace === face) === (cullMode === 'front');\n}\n\nfunction faceColor(face: 'cw' | 'ccw', frontFace: GPUFrontFace, cullMode: GPUCullMode): Uint8Array {\n  // front facing color is green, non front facing is red, background is blue\n  const isCulled = faceIsCulled(face, frontFace, cullMode);\n  if (!isCulled && face === frontFace) {\n    return new Uint8Array([0x00, 0xff, 0x00, 0xff]);\n  } else if (isCulled) {\n    return new Uint8Array([0x00, 0x00, 0xff, 0xff]);\n  } else {\n    return new Uint8Array([0xff, 0x00, 0x00, 0xff]);\n  }\n}\n\nexport const g = makeTestGroup(GPUTest);\n\ng.test('culling')\n  .params(\n    params()\n      .combine(poptions('frontFace', ['ccw', 'cw'] as const))\n      .combine(poptions('cullMode', ['none', 'front', 'back'] as const))\n      .combine(\n        poptions('depthStencilFormat', [\n          null,\n          'depth24plus',\n          'depth32float',\n          'depth24plus-stencil8',\n        ] as const)\n      )\n      // TODO: test triangle-strip as well\n      .combine(poptions('primitiveTopology', ['triangle-list'] as const))\n  )\n  .fn(t => {\n    const size = 4;\n    const format = 'rgba8unorm';\n\n    const texture = t.device.createTexture({\n      size: { width: size, height: size, depth: 1 },\n      format,\n      usage: GPUTextureUsage.OUTPUT_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n    });\n\n    const depthTexture = t.params.depthStencilFormat\n      ? t.device.createTexture({\n          size: { width: size, height: size, depth: 1 },\n          format: t.params.depthStencilFormat,\n          usage: GPUTextureUsage.OUTPUT_ATTACHMENT,\n        })\n      : null;\n\n    const encoder = t.device.createCommandEncoder();\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          attachment: texture.createView(),\n          loadValue: { r: 0.0, g: 0.0, b: 1.0, a: 1.0 },\n        },\n      ],\n      depthStencilAttachment: depthTexture\n        ? {\n            attachment: depthTexture.createView(),\n            depthLoadValue: 1.0,\n            depthStoreOp: 'store',\n            stencilLoadValue: 0,\n            stencilStoreOp: 'store',\n          }\n        : undefined,\n    });\n\n    // Draw two triangles with different winding orders:\n    // 1. The top-left one is counterclockwise (CCW)\n    // 2. The bottom-right one is clockwise (CW)\n    pass.setPipeline(\n      t.device.createRenderPipeline({\n        vertexStage: {\n          module: t.device.createShaderModule({\n            code: `\n              [[builtin(position)]] var<out> Position : vec4<f32>;\n              [[builtin(vertex_index)]] var<in> VertexIndex : i32;\n\n              [[stage(vertex)]] fn main() -> void {\n                const pos : array<vec2<f32>, 6> = array<vec2<f32>, 6>(\n                    vec2<f32>(-1.0,  1.0),\n                    vec2<f32>(-1.0,  0.0),\n                    vec2<f32>( 0.0,  1.0),\n                    vec2<f32>( 0.0, -1.0),\n                    vec2<f32>( 1.0,  0.0),\n                    vec2<f32>( 1.0, -1.0));\n                Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n                return;\n              }`,\n          }),\n          entryPoint: 'main',\n        },\n        fragmentStage: {\n          module: t.device.createShaderModule({\n            code: `\n              [[location(0)]] var<out> fragColor : vec4<f32>;\n              [[builtin(front_facing)]] var<in> FrontFacing : bool;\n\n              [[stage(fragment)]] fn main() -> void {\n                if (FrontFacing) {\n                  fragColor = vec4<f32>(0.0, 1.0, 0.0, 1.0);\n                } else {\n                  fragColor = vec4<f32>(1.0, 0.0, 0.0, 1.0);\n                }\n                return;\n              }`,\n          }),\n          entryPoint: 'main',\n        },\n        primitiveTopology: t.params.primitiveTopology,\n        rasterizationState: {\n          frontFace: t.params.frontFace,\n          cullMode: t.params.cullMode,\n        },\n        colorStates: [{ format }],\n        depthStencilState: depthTexture\n          ? { format: t.params.depthStencilFormat as GPUTextureFormat }\n          : undefined,\n      })\n    );\n\n    pass.draw(6, 1, 0, 0);\n    pass.endPass();\n\n    t.device.defaultQueue.submit([encoder.finish()]);\n\n    // front facing color is green, non front facing is red, background is blue\n    const kCCWTriangleTopLeftColor = faceColor('ccw', t.params.frontFace, t.params.cullMode);\n    t.expectSinglePixelIn2DTexture(\n      texture,\n      format,\n      { x: 0, y: 0 },\n      { exp: kCCWTriangleTopLeftColor }\n    );\n\n    const kCWTriangleBottomRightColor = faceColor('cw', t.params.frontFace, t.params.cullMode);\n    t.expectSinglePixelIn2DTexture(\n      texture,\n      format,\n      { x: size - 1, y: size - 1 },\n      { exp: kCWTriangleBottomRightColor }\n    );\n    // TODO: check the contents of the depth and stencil outputs\n  });\n"],"file":"culling_tests.spec.js"}